general:
  branches:
    only:
      - testci

machine:
  environment:
    DOCKER_HOST: tcp://localhost:2375
  services:
    - docker
  pre:
    - echo 'DOCKER_OPTS="${DOCKER_OPTS} -H tcp://127.0.0.1:2375 -H unix:///var/run/docker.sock"' | sudo tee -a /etc/default/docker

dependencies:
  override:
    - case $CIRCLE_NODE_INDEX in 0) ./circle.sh cache epel-6-x86_64 centos-6 quay.io/signalfuse/collectd-build-centos > >(tee $CIRCLE_ARTIFACTS/cache.centos-6.stdout.txt 2> >(tee $CIRCLE_ARTIFACTS/cache.centos6.stderr.txt >&2) ;; 1) ./circle.sh cache ubuntu1204 precise none > >(tee $CIRCLE_ARTIFACTS/cache.ubuntu1204.stdout.txt2> >(tee $CIRCLE_ARTIFACTS/cache.ubuntu1204.stderr.txt >&2) ;; esac:
      parallel: true
 
test:
  override:
    - ./circle.sh test > >(tee $CIRCLE_ARTIFACTS/test.stdout.txt) 2> >(tee $CIRCLE_ARTIFACTS/test.stderr.txt >&2):
        parallel: true
        timeout: 3000

deployment:
  branch: [testci]
  commands:
#    - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS quay.io
    - ./circle.sh deploy
